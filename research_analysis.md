# 算法研究与性能分析

## 项目规模
- **图片数量**: 140万张
- **目标**: 每张图片生成20张输出图片
- **总输出**: 2800万张图片

## 阶段2: AI模型选择分析

### 2.1 语义分割方案对比

#### 当前选择: SAM 2.1 + LangSAM
**优点:**
- 零样本分割能力强
- 支持文本引导分割
- 分割精度高

**缺点:**
- **性能瓶颈**: SAM 2.1推理速度较慢
  - ViT-B编码器: ~2-5 FPS (单张, GPU)
  - ViT-S编码器: ~5-10 FPS (单张, GPU)
- 内存占用大 (ViT-B: ~2GB, ViT-S: ~1GB)
- 对每个类别需要单独推理，N个类别 = N次推理

**140万张图片估算:**
- 假设5个类别, ViT-S编码器
- 单张处理时间: 5个类别 × (1/8秒) = 0.625秒
- 总时间: 1,400,000 × 0.625秒 = 875,000秒 ≈ **243小时** (单GPU)
- 需要多GPU并行或更快的模型

#### 替代方案1: SegFormer (MIT-B0/B1)
**优点:**
- 推理速度快: ~30-50 FPS (GPU)
- 内存占用小: ~500MB
- 支持多类别一次性输出
- 精度与SAM接近

**缺点:**
- 需要预训练模型
- 类别固定，灵活性较低

**性能估算:**
- 单张处理: 1/40秒 = 0.025秒
- 总时间: 1,400,000 × 0.025秒 = 35,000秒 ≈ **9.7小时** (单GPU)
- **速度提升: 25倍**

#### 替代方案2: DeepLabV3+ (MobileNetV3)
**优点:**
- 推理速度极快: ~60-100 FPS (GPU)
- 内存占用极小: ~200MB
- 移动端优化

**缺点:**
- 精度略低于SAM
- 需要预训练模型

**性能估算:**
- 单张处理: 1/80秒 = 0.0125秒
- 总时间: 1,400,000 × 0.0125秒 = 17,500秒 ≈ **4.9小时** (单GPU)
- **速度提升: 50倍**

#### 替代方案3: 混合方案
- 使用SegFormer进行快速初步分割
- 对关键区域使用SAM 2.1精细分割
- 平衡速度与精度

### 2.2 深度估计方案对比

#### 当前选择: Depth Anything V2
**优点:**
- 精度高
- 支持多种场景

**缺点:**
- 推理速度: ~10-15 FPS (GPU)
- 内存占用: ~1.5GB

**140万张图片估算:**
- 单张处理: 1/12秒 = 0.083秒
- 总时间: 1,400,000 × 0.083秒 = 116,200秒 ≈ **32.3小时** (单GPU)

#### 替代方案1: MiDaS (Small)
**优点:**
- 推理速度快: ~30-40 FPS (GPU)
- 内存占用小: ~500MB
- 精度良好

**性能估算:**
- 单张处理: 1/35秒 = 0.029秒
- 总时间: 1,400,000 × 0.029秒 = 40,600秒 ≈ **11.3小时** (单GPU)
- **速度提升: 2.8倍**

#### 替代方案2: DPT (Depth Prediction Transformer)
**优点:**
- 精度高
- 推理速度: ~15-20 FPS

**性能估算:**
- 单张处理: 1/17秒 = 0.059秒
- 总时间: 1,400,000 × 0.059秒 = 82,600秒 ≈ **23小时** (单GPU)
- **速度提升: 1.4倍**

### 2.3 推荐方案

#### 方案A: 速度优先
- **语义分割**: SegFormer-B1
- **深度估计**: MiDaS Small
- **总处理时间**: ~21小时 (单GPU)
- **精度**: 良好 (略低于SAM)

#### 方案B: 精度优先 ✅ **已选择**
- **语义分割**: SAM 2.1 (ViT-S/ViT-B)
- **深度估计**: Depth Anything V2
- **总处理时间**: ~275小时 (单GPU, 预计需多GPU并行)
- **精度**: 最高

#### 方案C: 平衡方案
- **语义分割**: SegFormer-B2
- **深度估计**: Depth Anything V2
- **总处理时间**: ~42小时 (单GPU)
- **精度**: 高

## 阶段3: 后处理算法分析

### 3.1 形态学闭运算
- **时间复杂度**: O(H × W × K²)
- **性能**: 快速 (NumPy优化)
- **140万张估算**: 每张 ~0.01秒, 总计 ~3.9小时
- **结论**: 算法合适，无需替换

### 3.2 中值滤波
- **时间复杂度**: O(H × W × K² × log K)
- **性能**: 中等 (OpenCV优化)
- **140万张估算**: 每张 ~0.02秒, 总计 ~7.8小时
- **结论**: 算法合适，可考虑减小kernel_size

## 性能优化建议

### 1. 批处理 (Batch Processing)
- 将多张图片打包成batch
- GPU利用率提升 3-5倍
- **预计总时间减少 60-70%**

### 2. 多GPU并行
- 使用4个GPU: 时间减少到 1/4
- 使用8个GPU: 时间减少到 1/8

### 3. 图片预处理优化
- 如果原图很大，先resize到固定尺寸 (如1024×1024)
- 减少计算量

### 4. 流水线处理
- 阶段1-7可以流水线化
- 当阶段2处理第N张图时，阶段1可以处理第N+1张图

## 最终推荐

**✅ 已选择: 方案B (精度优先)**

对于140万张图片，使用精度优先方案:
1. SAM 2.1 (ViT-S/ViT-B) 进行语义分割
2. Depth Anything V2 进行深度估计
3. 使用多GPU并行处理
4. 优化批处理策略

**预计总时间 (精度优先):**
- 单GPU: ~275小时 (约11.5天)
- 4 GPU并行: ~69小时 (约2.9天)
- 8 GPU并行: ~34小时 (约1.4天)
- 16 GPU并行: ~17小时

**性能优化建议:**
- 使用ViT-S编码器而非ViT-B (速度提升约2倍，精度略降)
- 优化图像尺寸 (如1024×1024)
- 使用混合精度推理 (FP16)
- 批量处理多个类别

## 下一步行动

1. ✅ 实现阶段1 (预处理) - 开始
2. ⏳ 在小样本上测试SAM 2.1 vs SegFormer
3. ⏳ 在小样本上测试Depth Anything V2 vs MiDaS
4. ⏳ 实现批处理框架
5. ⏳ 性能基准测试

